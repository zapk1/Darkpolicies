<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StreamX - Social Feed</title>
    
    <!-- Firebase v8 (OLD SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            min-height: 100vh;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .loading-box {
            background: white;
            padding: 3rem;
            border-radius: 1.5rem;
            text-align: center;
            max-width: 450px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .loading-box h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #000;
        }
        
        .loading-box .warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .loading-box .warning p {
            color: #92400e;
            font-weight: 600;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }
        
        .loading-box .warning small {
            color: #b45309;
            font-size: 0.875rem;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f4f6;
            border-top-color: #000;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-status {
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 1rem;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
        
        /* Header */
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 4rem;
            padding: 0 2rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 2rem;
            height: 2rem;
            background: #000000;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
        }
        
        .logo h1 {
            font-size: 1.25rem;
            font-weight: bold;
            color: #000000;
        }
        
        .nav {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .nav-btn.active {
            background: #000000;
            color: #ffffff;
        }
        
        .nav-btn:hover:not(.active) {
            background: #f3f4f6;
        }
        
        .profile-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e5e7eb;
        }
        
        .profile-icon:hover {
            border-color: #000000;
        }

        .admin-btn {
            background: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .admin-btn:hover {
            background: #b91c1c;
        }
        
        /* Main Content */
        .main-content {
            max-width: 32rem;
            margin: 0 auto;
            padding: 4rem 1rem;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #000000;
            margin-bottom: 0.5rem;
        }
        
        .page-header p {
            color: #6b7280;
            font-size: 1rem;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 1rem center;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #000000;
        }
        
        /* Partner Banner */
        .partner-banner {
            background: #000000;
            color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            border: 1px solid #000000;
        }
        
        .partner-title {
            font-size: 1.125rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .partner-amount {
            color: #fbbf24;
            font-weight: bold;
        }
        
        .partner-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }
        
        .partner-badge {
            background: #374151;
            color: #d1d5db;
            padding: 0.25rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 5rem 0;
        }
        
        .empty-icon {
            width: 4rem;
            height: 4rem;
            margin: 0 auto 1.5rem;
            background: #f3f4f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .empty-state h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #000000;
            margin-bottom: 0.5rem;
        }
        
        .empty-state p {
            color: #6b7280;
        }
        
        /* Posts Feed */
        .posts-feed {
            display: grid;
            gap: 1.5rem;
        }
        
        /* Post Card */
        .post-card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .post-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            padding-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .post-date-location {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .post-views {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            color: #3b82f6;
            font-weight: 600;
            font-size: 0.9375rem;
        }
        
        .post-views svg {
            width: 20px;
            height: 20px;
            stroke: #3b82f6;
            fill: none;
        }
        
        .post-content {
            padding: 0 1rem;
        }
        
        .post-caption {
            color: #000000;
            line-height: 1.6;
            margin-bottom: 0.75rem;
        }
        
        .post-media {
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 0.75rem;
        }
        
        .post-image {
            width: 100%;
            max-height: 24rem;
            object-fit: cover;
        }
        
        .post-hashtags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        /* User Info */
        .post-user {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-top: 1px solid #f3f4f6;
            background: #f9fafb;
        }
        
        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            color: #000000;
            font-size: 0.875rem;
        }
        
        .user-email {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Lightbox */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        
        .lightbox-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 0.5rem;
        }
        
        .lightbox-close {
            position: absolute;
            top: -3rem;
            right: 0;
            width: 2rem;
            height: 2rem;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .hidden { display: none !important; }
        
        /* Create Post */
        .create-form {
            max-width: 32rem;
            margin: 0 auto;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-input,
        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-family: inherit;
        }
        
        .form-textarea {
            min-height: 6rem;
            resize: vertical;
        }
        
        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #000000;
        }
        
        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-area:hover {
            border-color: #000000;
            background: #f9fafb;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #000000;
            color: #ffffff;
        }
        
        .btn-primary:hover {
            background: #374151;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .preview-image {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: 0.5rem;
        }
        
        /* Google Sign In Button */
        .google-btn {
            background: #fff;
            border: 1px solid #dadce0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #3c4043;
            transition: all 0.2s;
        }
        
        .google-btn:hover {
            background: #f8f9fa;
            border-color: #d2d4d6;
        }
        
        /* Profile */
        .profile-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .profile-avatar-large {
            width: 8rem;
            height: 8rem;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e5e7eb;
            margin: 0 auto 1.5rem;
        }
        
        .profile-name {
            font-size: 1.875rem;
            font-weight: bold;
            color: #000000;
            margin-bottom: 0.5rem;
        }
        
        .profile-email {
            color: #6b7280;
            margin-bottom: 1rem;
        }
        
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 2rem;
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .stat-value {
            font-weight: bold;
            font-size: 1.125rem;
            color: #000000;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <h2>üáøüá¶ Loading StreamX</h2>
            <div class="warning">
                <p>‚ö†Ô∏è Our app is slow to load due to bad internet</p>
                <small>Please wait 3-5 minutes to get everything loaded. South African servers loading...</small>
            </div>
            <div class="loading-status">Connecting to Firebase...</div>
        </div>
    </div>

    <div id="app" style="display:none;">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">S</div>
                    <h1>StreamX üáøüá¶</h1>
                </div>
                
                <nav class="nav">
                    <button class="nav-btn" data-page="feed">Feed</button>
                    <span style="color: #9ca3af; margin: 0 0.5rem;">+</span>
                    <button class="nav-btn" data-page="create">Create</button>
                    <img id="headerProfileIcon" class="profile-icon" src="" alt="Profile" style="display:none;">
                    <button class="admin-btn" onclick="promptAdminPassword()">Admin</button>
                </nav>
            </div>
        </header>

        <!-- Feed Page -->
        <div id="feedPage" class="main-content">
            <div class="page-header">
                <h1>Feed</h1>
                <p>South African Community üáøüá¶</p>
            </div>
            
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search posts...">
            </div>
            
            <div class="partner-banner">
                <div class="partner-title">
                    <svg width="20" height="20" fill="#fbbf24" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                    Become a StreamX Partner!
                </div>
                <p>Get <span class="partner-amount">R15 000 monthly</span> for being a top creator. Reach 300 posts in a year to qualify.</p>
                <div class="partner-footer">
                    <span>üáøüá¶ South African creators only</span>
                    <span class="partner-badge">Coming Soon</span>
                </div>
            </div>

            <div id="postsFeed" class="posts-feed"></div>
        </div>

        <!-- Create Page -->
        <div id="createPage" class="main-content hidden">
            <div class="page-header">
                <h1>Create</h1>
                <p>Share your moment üáøüá¶</p>
            </div>
            
            <div class="create-form">
                <div class="form-group">
                    <textarea id="createCaption" class="form-textarea" placeholder="What's on your mind?" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <input type="text" id="createLocation" class="form-input" placeholder="üìç Location">
                </div>
                
                <div class="form-group">
                    <input type="text" id="createHashtag" class="form-input" placeholder="# Add hashtag">
                </div>
                
                <div id="hashtagsList" style="display:flex;flex-wrap:wrap;gap:0.5rem;margin-bottom:1rem;"></div>
                
                <div id="previewContainer" class="preview-grid hidden"></div>
                
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput" accept="image/*,video/*" multiple style="display:none;">
                    <svg width="32" height="32" fill="#9ca3af" viewBox="0 0 24 24" style="margin:0 auto 0.5rem;display:block;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    <p style="color:#6b7280;">Click to upload photos or videos</p>
                </div>
                
                <button class="btn btn-primary btn-block" id="createPostBtn">Share Post üöÄ</button>
            </div>
        </div>

        <!-- Profile Page -->
        <div id="profilePage" class="main-content hidden">
            <div class="profile-header">
                <img id="profileAvatar" class="profile-avatar-large" src="" alt="Profile">
                <h1 class="profile-name" id="profileName">User</h1>
                <p class="profile-email" id="profileEmail">user@example.com</p>
                
                <div class="profile-stats">
                    <div>
                        <span class="stat-value" id="profilePostCount">0</span>
                        <span>Posts</span>
                    </div>
                    <div>
                        <span class="stat-value" id="profileViewCount">0</span>
                        <span>Total Views</span>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-block" style="margin-bottom:2rem;" onclick="auth.signOut()">Logout</button>
            
            <h2 style="margin:2rem 0 1rem;font-size:1.5rem;font-weight:bold;">My Posts</h2>
            <div id="profilePosts" class="posts-feed"></div>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="main-content hidden">
            <div style="background:#f9fafb;border:1px solid #e5e7eb;border-radius:0.5rem;padding:1.5rem;">
                <h2 style="font-size:1.25rem;font-weight:bold;margin-bottom:1rem;">Admin Panel üõ°Ô∏è</h2>
                <div id="adminPostsList"></div>
            </div>
        </div>

        <!-- Lightbox -->
        <div id="lightbox" class="lightbox">
            <div class="lightbox-content">
                <button class="lightbox-close" id="lightboxClose">√ó</button>
                <img id="lightboxImage" class="lightbox-image" src="" alt="">
            </div>
        </div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDAZwvenI3n3u6y16tF0ENlJLpSTFhjJlY",
            authDomain: "streamxpro-37aaf.firebaseapp.com",
            databaseURL: "https://streamxpro-37aaf-default-rtdb.firebaseio.com",
            projectId: "streamxpro-37aaf",
            storageBucket: "streamxpro-37aaf.firebasestorage.app",
            messagingSenderId: "874159026275",
            appId: "1:874159026275:web:698e236398b9211b9d0856"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();
        
        const ADMIN_PASSWORD = 'VNAXXTTM';
        
        let posts = [];
        let users = {};
        let currentUser = null;
        let currentPage = 'feed';
        let uploadedFiles = [];
        let currentHashtags = [];
        
        // Show loading for minimum 3 seconds
        setTimeout(function() {
            document.getElementById('loadingOverlay').style.display = 'none';
            checkAuth();
        }, 3000);
        
        // Auth Check
        function checkAuth() {
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    document.getElementById('app').style.display = 'block';
                    updateHeaderProfileIcon();
                    loadAllData();
                } else {
                    signInWithGoogle();
                }
            });
        }
        
        // Google Sign In
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(function(error) {
                alert('Login failed: ' + error.message);
            });
        }
        
        // Load All Data
        function loadAllData() {
            database.ref('posts').on('value', function(snapshot) {
                const data = snapshot.val();
                posts = data ? Object.keys(data).map(function(key) {
                    return Object.assign({id: key}, data[key]);
                }).sort(function(a, b) {
                    return new Date(b.created_date) - new Date(a.created_date);
                }) : [];
                
                if (currentPage === 'feed') renderPosts();
                if (currentPage === 'profile') renderProfile();
                if (currentPage === 'admin') renderAdminPanel();
            });
            
            database.ref('users').on('value', function(snapshot) {
                users = snapshot.val() || {};
            });
        }
        
        function updateHeaderProfileIcon() {
            const icon = document.getElementById('headerProfileIcon');
            icon.src = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName);
            icon.style.display = 'block';
            icon.onclick = function() { navigateTo('profile'); };
        }
        
        // Navigation
        document.querySelectorAll('.nav-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigateTo(btn.getAttribute('data-page'));
            });
        });
        
        function navigateTo(page) {
            currentPage = page;
            
            document.getElementById('feedPage').classList.add('hidden');
            document.getElementById('createPage').classList.add('hidden');
            document.getElementById('profilePage').classList.add('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(function(btn) {
                btn.classList.remove('active');
                if (btn.getAttribute('data-page') === page) btn.classList.add('active');
            });
            
            if (page === 'feed') {
                document.getElementById('feedPage').classList.remove('hidden');
                renderPosts();
            } else if (page === 'create') {
                document.getElementById('createPage').classList.remove('hidden');
            } else if (page === 'profile') {
                document.getElementById('profilePage').classList.remove('hidden');
                renderProfile();
            } else if (page === 'admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
                renderAdminPanel();
            }
        }
        
        window.promptAdminPassword = function() {
            const savedAuth = sessionStorage.getItem('streamx-admin-auth');
            if (savedAuth === ADMIN_PASSWORD) {
                navigateTo('admin');
                return;
            }
            
            const password = prompt('Enter admin password:');
            if (password === ADMIN_PASSWORD) {
                sessionStorage.setItem('streamx-admin-auth', ADMIN_PASSWORD);
                navigateTo('admin');
            } else if (password) {
                alert('Incorrect password!');
            }
        };
        
        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            renderPosts(e.target.value);
        });
        
        // Render Posts
        function renderPosts(searchQuery) {
            searchQuery = searchQuery || '';
            let filtered = posts;
            
            if (searchQuery) {
                const query = searchQuery.toLowerCase();
                filtered = posts.filter(function(post) {
                    return (post.caption && post.caption.toLowerCase().includes(query)) ||
                           (post.location && post.location.toLowerCase().includes(query));
                });
            }
            
            const container = document.getElementById('postsFeed');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon"><svg width="32" height="32" fill="#9ca3af" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg></div><h2>No posts found</h2><p>' + (searchQuery ? 'Try a different search.' : 'Be the first to post! üáøüá¶') + '</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(function(post) { return createPostHTML(post); }).join('');
        }
        
        function createPostHTML(post) {
            const urls = post.content_urls || [];
            const postUserKey = post.created_by ? post.created_by.replace(/[.#$\[\]]/g, '_') : '';
            const postUser = users[postUserKey] || { 
                full_name: 'User', 
                email: post.created_by,
                profile_picture: 'https://ui-avatars.com/api/?name=User&size=32'
            };
            
            let imageHTML = '';
            if (urls.length > 0) {
                imageHTML = '<div class="post-media" onclick="openLightbox(\'' + urls[0] + '\')"><img class="post-image" src="' + urls[0] + '" alt="Post"></div>';
            }
            
            return '<div class="post-card"><div class="post-header"><div class="post-date-location">' + new Date(post.created_date).toLocaleDateString() + (post.location ? ' ‚Ä¢ üìç ' + post.location : '') + '</div><div class="post-views"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg><span>' + (post.views_count || 0).toLocaleString() + ' views</span></div></div><div class="post-content">' + (post.caption ? '<p class="post-caption">' + post.caption + '</p>' : '') + imageHTML + '</div><div class="post-user"><img class="user-avatar" src="' + postUser.profile_picture + '"><div class="user-info"><div class="user-name">' + postUser.full_name + '</div><div class="user-email">' + postUser.email + '</div></div></div></div>';
        }
        
        // Create Post
        const fileInput = document.getElementById('fileInput');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const previewContainer = document.getElementById('previewContainer');
        const createPostBtn = document.getElementById('createPostBtn');
        
        fileUploadArea.addEventListener('click', function() { fileInput.click(); });
        
        fileInput.addEventListener('change', function(e) {
            uploadedFiles = Array.from(e.target.files);
            renderPreviews();
        });
        
        function renderPreviews() {
            if (uploadedFiles.length === 0) {
                previewContainer.classList.add('hidden');
                return;
            }
            
            previewContainer.classList.remove('hidden');
            previewContainer.innerHTML = uploadedFiles.map(function(file) {
                const url = URL.createObjectURL(file);
                return '<img class="preview-image" src="' + url + '">';
            }).join('');
        }
        
        document.getElementById('createHashtag').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = this.value.trim().replace('#', '');
                if (tag && !currentHashtags.includes(tag)) {
                    currentHashtags.push(tag);
                    renderHashtags();
                    this.value = '';
                }
            }
        });
        
        function renderHashtags() {
            document.getElementById('hashtagsList').innerHTML = currentHashtags.map(function(tag) { 
                return '<span style="background:#f3f4f6;padding:0.375rem 0.75rem;border-radius:9999px;font-size:0.875rem;">#' + tag + ' <button onclick="removeHashtag(\'' + tag + '\')" style="background:none;border:none;cursor:pointer;">√ó</button></span>'; 
            }).join('');
        }
        
        window.removeHashtag = function(tag) {
            currentHashtags = currentHashtags.filter(function(t) { return t !== tag; });
            renderHashtags();
        };
        
        createPostBtn.addEventListener('click', function() {
            const caption = document.getElementById('createCaption').value.trim();
            const location = document.getElementById('createLocation').value.trim();
            
            if (!caption && uploadedFiles.length === 0) {
                alert('Add caption or upload media!');
                return;
            }
            
            const contentUrls = [];
            let processedFiles = 0;
            
            if (uploadedFiles.length === 0) {
                submitPost(caption, location, contentUrls);
            } else {
                uploadedFiles.forEach(function(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        contentUrls.push(e.target.result);
                        processedFiles++;
                        if (processedFiles === uploadedFiles.length) {
                            submitPost(caption, location, contentUrls);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
        });
        
        function submitPost(caption, location, contentUrls) {
            const initialViews = Math.floor(Math.random() * 50000) + 10000;
            
            const newPost = {
                caption: caption,
                location: location,
                hashtags: currentHashtags.slice(),
                content_urls: contentUrls,
                views_count: initialViews,
                created_date: new Date().toISOString(),
                created_by: currentUser.email
            };
            
            database.ref('posts').push(newPost);
            
            document.getElementById('createCaption').value = '';
            document.getElementById('createLocation').value = '';
            uploadedFiles = [];
            currentHashtags = [];
            previewContainer.classList.add('hidden');
            renderHashtags();
            
            alert('Posted! üáøüá¶ ' + initialViews.toLocaleString() + ' views!');
            navigateTo('feed');
        }
        
        // Profile
        function renderProfile() {
            document.getElementById('profileAvatar').src = currentUser.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(currentUser.displayName);
            document.getElementById('profileName').textContent = currentUser.displayName || 'User';
            document.getElementById('profileEmail').textContent = currentUser.email;
            
            const userPosts = posts.filter(function(p) { return p.created_by === currentUser.email; });
            document.getElementById('profilePostCount').textContent = userPosts.length;
            document.getElementById('profileViewCount').textContent = userPosts.reduce(function(sum, p) { return sum + (p.views_count || 0); }, 0).toLocaleString();
            
            const container = document.getElementById('profilePosts');
            if (userPosts.length === 0) {
                container.innerHTML = '<div class="empty-state"><h2>No posts yet</h2><p>Share your first post! üáøüá¶</p></div>';
            } else {
                container.innerHTML = userPosts.map(function(post) { return createPostHTML(post); }).join('');
            }
        }
        
        // Admin Panel
        function renderAdminPanel() {
            const container = document.getElementById('adminPostsList');
            
            if (posts.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#6b7280;">No posts</p>';
                return;
            }
            
            container.innerHTML = posts.map(function(post) {
                return '<div style="display:flex;align-items:center;gap:1rem;padding:0.75rem;background:white;border:1px solid #e5e7eb;border-radius:0.5rem;margin-bottom:0.5rem;"><img src="' + ((post.content_urls && post.content_urls[0]) || 'https://via.placeholder.com/64') + '" style="width:4rem;height:4rem;object-fit:cover;border-radius:0.375rem;"><div style="flex:1;"><div style="font-weight:600;">' + (post.caption || 'No caption') + '</div><div style="font-size:0.875rem;color:#6b7280;">' + (post.views_count || 0).toLocaleString() + ' views</div></div><div style="display:flex;gap:0.5rem;"><button onclick="increaseViews(\'' + post.id + '\', 10000)" style="background:#3b82f6;color:white;padding:0.5rem 1rem;border:none;border-radius:0.375rem;cursor:pointer;">+10K</button><button onclick="deletePost(\'' + post.id + '\')" style="background:#ef4444;color:white;padding:0.5rem 1rem;border:none;border-radius:0.375rem;cursor:pointer;">Delete</button></div></div>';
            }).join('');
        }
        
        window.increaseViews = function(postId, amount) {
            const post = posts.find(function(p) { return p.id === postId; });
            if (post) {
                database.ref('posts/' + postId + '/views_count').set((post.views_count || 0) + amount);
            }
        };
        
        window.deletePost = function(postId) {
            if (confirm('Delete post?')) {
                database.ref('posts/' + postId).remove();
            }
        };
        
        // Lightbox
        document.getElementById('lightboxClose').addEventListener('click', function() {
            document.getElementById('lightbox').classList.remove('active');
        });
        
        window.openLightbox = function(imageSrc) {
            document.getElementById('lightboxImage').src = imageSrc;
            document.getElementById('lightbox').classList.add('active');
        };
    </script>
</body>
</html>
